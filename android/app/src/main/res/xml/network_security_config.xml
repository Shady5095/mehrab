<?xml version="1.0" encoding="utf-8"?>
<network-security-config>
    <!--
        Network Security Configuration for Mehrab App
        This configuration enforces HTTPS and provides certificate pinning
        for critical infrastructure.

        Security Fix: CWE-319 (Cleartext Transmission of Sensitive Information)
        CVSS Score: 7.4 (High)
    -->

    <!-- Base configuration for all domains -->
    <base-config cleartextTrafficPermitted="false">
        <!-- Trust system certificate authorities -->
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </base-config>

    <!-- Certificate pinning for WebRTC signaling server -->
    <domain-config cleartextTrafficPermitted="false">
        <domain includeSubdomains="true">signal.ahmedhany.dev</domain>
        <!--
            Certificate Pinning (RECOMMENDED but commented out)

            To enable certificate pinning:
            1. Get your server's certificate pin:
               openssl s_client -connect signal.ahmedhany.dev:443 | \
               openssl x509 -pubkey -noout | \
               openssl rsa -pubin -outform der | \
               openssl dgst -sha256 -binary | \
               openssl enc -base64

            2. Uncomment and add pins below:

            <pin-set expiration="2027-01-22">
                <pin digest="SHA-256">BASE64_ENCODED_PIN_HERE</pin>
                <pin digest="SHA-256">BACKUP_PIN_HERE</pin>
            </pin-set>

            IMPORTANT: Always have at least 2 pins (primary + backup)
                       to prevent lockout during certificate rotation
        -->
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </domain-config>

    <!-- Certificate pinning for TURN server -->
    <domain-config cleartextTrafficPermitted="false">
        <domain includeSubdomains="true">turn.ahmedhany.dev</domain>
        <!-- Pin configuration (see above for setup instructions) -->
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </domain-config>

    <!-- Firebase domains (no pinning needed, managed by Firebase SDK) -->
    <domain-config cleartextTrafficPermitted="false">
        <domain includeSubdomains="true">firebase.google.com</domain>
        <domain includeSubdomains="true">firebaseapp.com</domain>
        <domain includeSubdomains="true">googleapis.com</domain>
        <domain includeSubdomains="true">google.com</domain>
        <domain includeSubdomains="true">gstatic.com</domain>
        <trust-anchors>
            <certificates src="system" />
        </trust-anchors>
    </domain-config>

    <!--
        Development/Debug Configuration (REMOVE IN PRODUCTION)
        Allows cleartext traffic for local development only

        To enable for development:
        1. Create a separate network_security_config_debug.xml in res/xml-debug/
        2. Enable cleartext for localhost/IP addresses only

        Example debug config:
        <domain-config cleartextTrafficPermitted="true">
            <domain includeSubdomains="true">localhost</domain>
            <domain includeSubdomains="true">10.0.2.2</domain>
            <domain includeSubdomains="true">127.0.0.1</domain>
        </domain-config>
    -->
</network-security-config>
